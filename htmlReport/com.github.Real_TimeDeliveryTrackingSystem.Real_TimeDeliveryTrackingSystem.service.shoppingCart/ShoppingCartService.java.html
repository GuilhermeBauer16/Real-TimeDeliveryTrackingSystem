<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShoppingCartService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in Real-TimeDeliveryTrackingSystem (1) Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.shoppingCart</a> &gt; <span class="el_source">ShoppingCartService.java</span></div><h1>ShoppingCartService.java</h1><pre class="source lang-java linenums">package com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.shoppingCart;

import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.CustomerEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.ProductEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.ShoppingCartEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.TemporaryProductEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.values.CustomerVO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.values.ProductVO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.values.TemporaryProductVO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.exception.product.ProductNotAssociatedWithTheCustomerException;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.exception.shoppingCart.ShoppingCartNotFoundException;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.factory.ShoppingCartFactory;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.mapper.BuildMapper;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.repository.ShoppingCartRepository;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.request.ShoppingCartRequest;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.response.ShoppingCartResponse;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.contract.ShoppingCartServiceContract;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.customer.CustomerService;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.product.ProductService;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.product.TemporaryProductService;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.utils.QuantityUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
public class ShoppingCartService implements ShoppingCartServiceContract {

    private final CustomerService customerService;
    private final ProductService productService;
    private final ShoppingCartRepository repository;
    private final TemporaryProductService temporaryProductService;

    private static final String SHOPPING_CART_NOT_FOUND_MESSAGE = &quot;The ShoppingCart was not found!&quot;;
    private static final String PRODUCT_NOT_ASSOCIATED_WITH_USER_MESSAGE = &quot;This product is not associated with this Customer!&quot;;

    @Autowired
<span class="fc" id="L47">    public ShoppingCartService(CustomerService customerService, ProductService productService, ShoppingCartRepository repository, TemporaryProductService temporaryProductService) {</span>
<span class="fc" id="L48">        this.customerService = customerService;</span>
<span class="fc" id="L49">        this.productService = productService;</span>
<span class="fc" id="L50">        this.repository = repository;</span>
<span class="fc" id="L51">        this.temporaryProductService = temporaryProductService;</span>
<span class="fc" id="L52">    }</span>

    @Override
    @Transactional
    public ProductVO addToShoppingCart(ShoppingCartRequest shoppingCartRequest) {


<span class="fc" id="L59">        CustomerVO customerByEmail = customerService.findCustomerByEmail(retrieveUserEmail());</span>
<span class="fc" id="L60">        CustomerEntity customerEntity = BuildMapper.parseObject(new CustomerEntity(), customerByEmail);</span>

<span class="fc" id="L62">        ProductVO productVO = productService.findProductById(shoppingCartRequest.getProductId());</span>
<span class="fc" id="L63">        QuantityUtils.verifyIfQuantityRequiredIsHigherThanTheAvailable(shoppingCartRequest.getQuantity(), productVO.getQuantity());</span>
<span class="fc" id="L64">        QuantityUtils.checkIfQuantityIsHigherThanOne(shoppingCartRequest.getQuantity());</span>

<span class="fc" id="L66">        Optional&lt;ShoppingCartEntity&gt; shoppingCartByCustomerEmail = repository.findShoppingCartByCustomerEmail(retrieveUserEmail());</span>


<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (shoppingCartByCustomerEmail.isPresent()) {</span>


<span class="fc" id="L72">            ShoppingCartEntity shoppingCartEntity = shoppingCartByCustomerEmail.get();</span>


<span class="fc" id="L75">            List&lt;TemporaryProductEntity&gt; products = shoppingCartEntity.getTemporaryProducts();</span>

<span class="fc" id="L77">            addProductIfWasNotAdded(productVO.getId(), shoppingCartEntity);</span>

<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (verifyIfProductAlreadyAddToCustomerList(productVO.getId(), products)) {</span>

<span class="fc" id="L81">                TemporaryProductVO temporaryProductById = temporaryProductService.findTemporaryProductById(productVO.getId());</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">                if (shoppingCartRequest.getQuantity() &lt; temporaryProductById.getQuantity()) {</span>

<span class="fc" id="L85">                    ProductVO updatedProduct = updateProduct(shoppingCartRequest.getQuantity(), productVO);</span>
<span class="fc" id="L86">                    double updatedTotalPrice = shoppingCartEntity.getTotalPrice() - updatedProduct.getPrice();</span>
<span class="fc" id="L87">                    TemporaryProductVO temporaryProductVO = BuildMapper.parseObject(new TemporaryProductVO(), updatedProduct);</span>
<span class="fc" id="L88">                    temporaryProductService.updateTemporaryProduct(temporaryProductVO);</span>

<span class="fc" id="L90">                    shoppingCartEntity.setTotalPrice(shoppingCartEntity.getTotalPrice() - updatedTotalPrice);</span>

                }

<span class="fc bfc" id="L94" title="All 2 branches covered.">                if (shoppingCartRequest.getQuantity() &gt; temporaryProductById.getQuantity()) {</span>

<span class="fc" id="L96">                    int updatedQuantity = shoppingCartRequest.getQuantity() - temporaryProductById.getQuantity();</span>
<span class="fc" id="L97">                    double updatedPrice = updatedQuantity * productVO.getPrice();</span>
<span class="fc" id="L98">                    ProductVO updatedProduct = updateProduct(shoppingCartRequest.getQuantity(), productVO);</span>
<span class="fc" id="L99">                    TemporaryProductVO temporaryProductVO = BuildMapper.parseObject(new TemporaryProductVO(), updatedProduct);</span>
<span class="fc" id="L100">                    temporaryProductService.updateTemporaryProduct(temporaryProductVO);</span>
<span class="fc" id="L101">                    shoppingCartEntity.setTotalPrice(shoppingCartEntity.getTotalPrice() + updatedPrice);</span>


                }


<span class="fc" id="L107">            } else {</span>

<span class="fc" id="L109">                ProductVO updatedProduct = updateProduct(shoppingCartRequest.getQuantity(), productVO);</span>
<span class="fc" id="L110">                TemporaryProductEntity temporaryProductEntity = saveTemporaryProduct(updatedProduct);</span>
<span class="fc" id="L111">                shoppingCartEntity.setTotalPrice(shoppingCartEntity.getTotalPrice() + updatedProduct.getPrice());</span>
<span class="fc" id="L112">                shoppingCartEntity.getTemporaryProducts().add(temporaryProductEntity);</span>






            }


<span class="fc" id="L122">            repository.save(shoppingCartEntity);</span>


<span class="fc" id="L125">            return productVO;</span>

        }

<span class="fc" id="L129">        List&lt;ProductEntity&gt; productEntities = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L130">        List&lt;TemporaryProductEntity&gt; tempProducts = new ArrayList&lt;&gt;();</span>


<span class="fc" id="L133">        productEntities.add(BuildMapper.parseObject(new ProductEntity(), productVO));</span>

<span class="fc" id="L135">        ProductVO updatedProduct = updateProduct(shoppingCartRequest.getQuantity(), productVO);</span>

<span class="fc" id="L137">        tempProducts.add(saveTemporaryProduct(updatedProduct));</span>

<span class="fc" id="L139">        ShoppingCartEntity shoppingCartModel = ShoppingCartFactory.create(customerEntity, productEntities, productVO.getPrice(), tempProducts);</span>
<span class="fc" id="L140">        repository.save(shoppingCartModel);</span>

<span class="fc" id="L142">        return updatedProduct;</span>
    }



    @Override
    public TemporaryProductVO findShoppingCartTemporaryProductById(String id) {

<span class="fc" id="L150">        ShoppingCartEntity shoppingCartEntity = repository.findShoppingCartByCustomerEmail(retrieveUserEmail())</span>
<span class="fc" id="L151">                .orElseThrow(() -&gt; new ShoppingCartNotFoundException(SHOPPING_CART_NOT_FOUND_MESSAGE));</span>

<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (!verifyIfProductAlreadyAddToCustomerList(id, shoppingCartEntity.getTemporaryProducts())</span>
        ) {
<span class="fc" id="L155">            throw new ProductNotAssociatedWithTheCustomerException(PRODUCT_NOT_ASSOCIATED_WITH_USER_MESSAGE);</span>
        }

<span class="fc" id="L158">        return temporaryProductService.findTemporaryProductById(id);</span>
    }

    @Override
    @Transactional
    public void deleteShoppingCartTemporaryProductById(String id) {

<span class="fc" id="L165">        ShoppingCartEntity shoppingCartEntity = repository.findShoppingCartByCustomerEmail(retrieveUserEmail())</span>
<span class="fc" id="L166">                .orElseThrow(() -&gt; new ShoppingCartNotFoundException(SHOPPING_CART_NOT_FOUND_MESSAGE));</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (!verifyIfProductAlreadyAddToCustomerList(id, shoppingCartEntity.getTemporaryProducts())) {</span>

<span class="fc" id="L170">            throw new ProductNotAssociatedWithTheCustomerException(PRODUCT_NOT_ASSOCIATED_WITH_USER_MESSAGE);</span>
        }

<span class="fc" id="L173">        TemporaryProductVO temporaryProductById = temporaryProductService.findTemporaryProductById(id);</span>
<span class="fc" id="L174">        shoppingCartEntity.setTotalPrice(shoppingCartEntity.getTotalPrice() - temporaryProductById.getPrice());</span>
<span class="fc" id="L175">        repository.save(shoppingCartEntity);</span>

<span class="fc" id="L177">        temporaryProductService.deleteTemporaryProduct(id);</span>


<span class="fc" id="L180">    }</span>

    @Override
    public ShoppingCartResponse findShoppingCart() {

<span class="fc" id="L185">        ShoppingCartEntity shoppingCartEntity = repository.findShoppingCartByCustomerEmail(retrieveUserEmail())</span>
<span class="fc" id="L186">                .orElseThrow(() -&gt; new ShoppingCartNotFoundException(SHOPPING_CART_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L188">        return BuildMapper.parseObject(new ShoppingCartResponse(), shoppingCartEntity);</span>
    }


    @Override
    public Page&lt;TemporaryProductVO&gt; findShoppingCartProducts(Pageable pageable) {

<span class="fc" id="L195">        ShoppingCartEntity shoppingCartModel = repository.findShoppingCartByCustomerEmail(retrieveUserEmail())</span>
<span class="fc" id="L196">                .orElseThrow(() -&gt; new ShoppingCartNotFoundException(SHOPPING_CART_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L198">        Page&lt;TemporaryProductEntity&gt; allTemporaryProductsByShoppingCart = repository.</span>
<span class="fc" id="L199">                findAllTemporaryProductsByShoppingCart(shoppingCartModel.getId(), pageable);</span>
<span class="fc" id="L200">        List&lt;TemporaryProductVO&gt; temporaryProductVOS = allTemporaryProductsByShoppingCart.getContent()</span>
<span class="fc" id="L201">                .stream().map(temporaryProductEntity -&gt; BuildMapper.parseObject(new TemporaryProductVO(), temporaryProductEntity)).toList();</span>

<span class="fc" id="L203">        return new PageImpl&lt;&gt;(temporaryProductVOS, pageable, allTemporaryProductsByShoppingCart.getTotalElements());</span>
    }

    @Override
    public void deleteShoppingCart(String email) {

<span class="fc" id="L209">        ShoppingCartEntity shoppingCartEntity = repository.findShoppingCartByCustomerEmail(email)</span>
<span class="fc" id="L210">                .orElseThrow(() -&gt; new ShoppingCartNotFoundException(SHOPPING_CART_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L212">        repository.delete(shoppingCartEntity);</span>

<span class="fc" id="L214">    }</span>

    private static ProductVO updateProduct(int quantity, ProductVO productVO) {
<span class="fc" id="L217">        productVO.setQuantity(quantity);</span>
<span class="fc" id="L218">        productVO.setPrice(productVO.getPrice() * productVO.getQuantity());</span>
<span class="fc" id="L219">        return productVO;</span>
    }

    private TemporaryProductEntity saveTemporaryProduct(ProductVO productVO) {

<span class="fc" id="L224">        TemporaryProductVO temporaryProductVO = BuildMapper.parseObject(new TemporaryProductVO(), productVO);</span>
<span class="fc" id="L225">        TemporaryProductVO savedTemporaryProduct = temporaryProductService.createTemporaryProduct(temporaryProductVO);</span>
<span class="fc" id="L226">        return BuildMapper.parseObject(new TemporaryProductEntity(), savedTemporaryProduct);</span>
    }

    private String retrieveUserEmail() {

<span class="fc" id="L231">        UserDetails principal = (UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L232">        return principal.getUsername();</span>

    }


    private boolean verifyIfProductAlreadyAddToCustomerList(String productId, List&lt;TemporaryProductEntity&gt; productEntities) {


<span class="fc bfc" id="L240" title="All 2 branches covered.">        for (TemporaryProductEntity productEntity : productEntities) {</span>

<span class="fc bfc" id="L242" title="All 2 branches covered.">            if (productEntity.getId().equals(productId)) {</span>

<span class="fc" id="L244">                return true;</span>
            }
<span class="fc" id="L246">        }</span>

<span class="fc" id="L248">        return false;</span>
    }

    private void addProductIfWasNotAdded(String productId, ShoppingCartEntity shoppingCartEntity) {

<span class="fc" id="L253">        boolean productExists = shoppingCartEntity.getProducts()</span>
<span class="fc" id="L254">                .stream()</span>
<span class="fc" id="L255">                .anyMatch(product -&gt; product.getId().equals(productId));</span>

<span class="fc bfc" id="L257" title="All 2 branches covered.">        if (!productExists) {</span>
<span class="fc" id="L258">            ProductVO productById = productService.findProductById(productId);</span>

<span class="fc" id="L260">            shoppingCartEntity.getProducts().add(BuildMapper.parseObject(new ProductEntity(), productById));</span>
        }
<span class="fc" id="L262">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>