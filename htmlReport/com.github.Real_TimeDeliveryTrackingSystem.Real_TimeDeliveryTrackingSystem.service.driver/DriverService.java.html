<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DriverService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in Real-TimeDeliveryTrackingSystem (1) Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.driver</a> &gt; <span class="el_source">DriverService.java</span></div><h1>DriverService.java</h1><pre class="source lang-java linenums">package com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.driver;

import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.dto.PasswordDTO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.AddressEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.DriverEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.VehicleEntity;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.values.AddressVO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.entity.values.VehicleVO;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.exception.driver.DriverNotFoundException;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.exception.user.InvalidPasswordException;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.exception.vehicle.VehicleNotFoundException;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.mapper.BuildMapper;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.repository.DriverRepository;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.address.AddressService;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.contract.DriverServiceContract;
import com.github.Real_TimeDeliveryTrackingSystem.Real_TimeDeliveryTrackingSystem.service.vehicle.VehicleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class DriverService implements DriverServiceContract {

    private static final String DRIVER_NOT_FOUND_MESSAGE = &quot;This driver was not found, please verify the fields and try again.&quot;;
    private static final String INVALID_PASSWORD_MESSAGE = &quot;The password typed is incorrect,&quot; +
            &quot; please verify and try again.&quot;;

    private static final String VEHICLE_NOT_ASSOCIATED_MESSAGE = &quot;That vehicle was not associated with this user,&quot; +
            &quot; please verify the fields and try again.&quot;;

    private final DriverRepository repository;
    private final AddressService addressService;
    private final PasswordEncoder passwordEncoder;
    private final VehicleService vehicleService;

    @Autowired
<span class="fc" id="L44">    public DriverService(DriverRepository repository, AddressService addressService, PasswordEncoder passwordEncoder, VehicleService vehicleService) {</span>
<span class="fc" id="L45">        this.repository = repository;</span>
<span class="fc" id="L46">        this.addressService = addressService;</span>
<span class="fc" id="L47">        this.passwordEncoder = passwordEncoder;</span>
<span class="fc" id="L48">        this.vehicleService = vehicleService;</span>
<span class="fc" id="L49">    }</span>

    @Override
    @Transactional
    public void delete(PasswordDTO passwordDTO) {

<span class="fc" id="L55">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L56">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>


<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (!passwordEncoder.matches(passwordDTO.getPassword(), driverEntity.getUser().getPassword())) {</span>
<span class="fc" id="L60">            throw new InvalidPasswordException(INVALID_PASSWORD_MESSAGE);</span>

        }

<span class="fc" id="L64">        Page&lt;AddressVO&gt; allAddressesOfADriver = findAllAddressesOfADriver(Pageable.ofSize(10));</span>
<span class="fc" id="L65">        addressService.deleteAllAddresses(allAddressesOfADriver.getContent());</span>

<span class="fc" id="L67">        Page&lt;VehicleVO&gt; allVehicles = findAllVehicles(Pageable.ofSize(10));</span>
<span class="fc" id="L68">        vehicleService.deleteAllVehicles(allVehicles.getContent());</span>

<span class="fc" id="L70">        repository.delete(driverEntity);</span>

<span class="fc" id="L72">    }</span>


    @Override
    public AddressVO addAddressToDriver(AddressVO addressVO) {

<span class="fc" id="L78">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L79">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L81">        AddressVO createdAddress = addressService.create(addressVO);</span>
<span class="fc" id="L82">        driverEntity.getAddresses().add(BuildMapper.parseObject(new AddressEntity(), createdAddress));</span>
<span class="fc" id="L83">        repository.save(driverEntity);</span>

<span class="fc" id="L85">        return createdAddress;</span>
    }

    @Override
    public AddressVO updateAddressOfADriver(AddressVO addressVO) {

<span class="fc" id="L91">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L92">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L94">        addressService.verifyIfAddressIdIsAssociatedWithUser(addressVO.getId(), driverEntity.getAddresses());</span>


<span class="fc" id="L97">        return addressService.update(addressVO);</span>
    }

    @Override
    public AddressVO findAddressOfADriverByItsId(String addressId) {

<span class="fc" id="L103">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L104">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L106">        addressService.verifyIfAddressIdIsAssociatedWithUser(addressId, driverEntity.getAddresses());</span>

<span class="fc" id="L108">        return addressService.findById(addressId);</span>
    }

    @Override
    public Page&lt;AddressVO&gt; findAllAddressesOfADriver(Pageable pageable) {

<span class="fc" id="L114">        Page&lt;AddressEntity&gt; addressEntities = repository.findAddressesByDriverEmail(retrieveUserEmail(), pageable);</span>


<span class="fc" id="L117">        return addressEntities.map(addressEntity -&gt; BuildMapper.parseObject(new AddressVO(), addressEntity));</span>
    }

    @Override
    @Transactional
    public void deleteAddressOfADriver(String addressId) {

<span class="fc" id="L124">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L125">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L127">        addressService.verifyIfAddressIdIsAssociatedWithUser(addressId, driverEntity.getAddresses());</span>

<span class="fc" id="L129">        addressService.delete(addressId);</span>

<span class="fc" id="L131">    }</span>

    @Override
    public VehicleVO createVehicle(VehicleVO vehicleVO) {

<span class="fc" id="L136">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L137">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>
<span class="fc" id="L138">        VehicleVO createdVehicle = vehicleService.create(vehicleVO);</span>
<span class="fc" id="L139">        driverEntity.getVehicles().add(BuildMapper.parseObject(new VehicleEntity(), createdVehicle));</span>
<span class="fc" id="L140">        repository.save(driverEntity);</span>

<span class="fc" id="L142">        return createdVehicle;</span>
    }

    @Override
    public VehicleVO updateVehicle(VehicleVO vehicleVO) {

<span class="fc" id="L148">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L149">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L151">        verifyIfVehicleIdIsAssociatedWithDriver(vehicleVO.getId(), driverEntity.getVehicles());</span>

<span class="fc" id="L153">        return vehicleService.update(vehicleVO);</span>
    }

    @Override
    public VehicleVO findVehicleById(String id) {

<span class="fc" id="L159">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L160">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L162">        verifyIfVehicleIdIsAssociatedWithDriver(id, driverEntity.getVehicles());</span>

<span class="fc" id="L164">        return vehicleService.findById(id);</span>
    }

    @Override
    public VehicleVO findVehicleByLicensePlate(String licensePlate) {

<span class="fc" id="L170">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L171">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L173">        verifyIfLicensePlateIdIsAssociatedWithDriver(licensePlate, driverEntity.getVehicles());</span>

<span class="fc" id="L175">        return vehicleService.findByLicensePlate(licensePlate);</span>
    }

    @Override
    public Page&lt;VehicleVO&gt; findAllVehicles(Pageable pageable) {

<span class="fc" id="L181">        Page&lt;VehicleEntity&gt; vehiclesEntities = repository.findVehiclesByDriverEmail(retrieveUserEmail(), pageable);</span>


<span class="fc" id="L184">        return vehiclesEntities.map(vehicleEntity -&gt; BuildMapper.parseObject(new VehicleVO(), vehicleEntity));</span>
    }

    @Override
    @Transactional
    public void deleteVehicle(String id) {

<span class="fc" id="L191">        DriverEntity driverEntity = repository.findDriverByUserEmail(retrieveUserEmail())</span>
<span class="fc" id="L192">                .orElseThrow(() -&gt; new DriverNotFoundException(DRIVER_NOT_FOUND_MESSAGE));</span>

<span class="fc" id="L194">        verifyIfVehicleIdIsAssociatedWithDriver(id, driverEntity.getVehicles());</span>

<span class="fc" id="L196">        vehicleService.delete(id);</span>

<span class="fc" id="L198">    }</span>

    private void verifyIfVehicleIdIsAssociatedWithDriver(String vehicleId, List&lt;VehicleEntity&gt; vehicles) {

<span class="fc bfc" id="L202" title="All 2 branches covered.">        for (VehicleEntity vehicleEntity : vehicles) {</span>

<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (vehicleId.equals(vehicleEntity.getId())) {</span>
<span class="fc" id="L205">                return;</span>
            }
<span class="fc" id="L207">        }</span>

<span class="fc" id="L209">        throw new VehicleNotFoundException(VEHICLE_NOT_ASSOCIATED_MESSAGE);</span>
    }

    private void verifyIfLicensePlateIdIsAssociatedWithDriver(String licensePlate, List&lt;VehicleEntity&gt; vehicles) {

<span class="fc bfc" id="L214" title="All 2 branches covered.">        for (VehicleEntity vehicleEntity : vehicles) {</span>

<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (licensePlate.equals(vehicleEntity.getLicensePlate())) {</span>
<span class="fc" id="L217">                return;</span>
            }
<span class="fc" id="L219">        }</span>

<span class="fc" id="L221">        throw new VehicleNotFoundException(VEHICLE_NOT_ASSOCIATED_MESSAGE);</span>
    }


    private String retrieveUserEmail() {

<span class="fc" id="L227">        UserDetails principal = (UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L228">        return principal.getUsername();</span>

    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>